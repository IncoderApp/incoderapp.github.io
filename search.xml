<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Github Action 自动部署网站</title>
      <link href="/2021/06/29/github-action-auto/"/>
      <url>/2021/06/29/github-action-auto/</url>
      
        <content type="html"><![CDATA[<p>简单来说 <a href="https://github.com/features/actions">Github Action</a> 是 <a href="https://github.com/">GitHub</a> 提供的一项支持自动化构建项目，发布项目等一些列自动化的 CI 工具，在一定程度上让我们的开发工作，发布工作更加优雅和安全（只需要配置好相关的执行脚本），让我们更加专注于你所作事情的本身内容</p><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>和之前构建个人博客一样，将源码和生成的静态网站文件都放在同一个 Github 仓库中，master(或 main) 分支存放编译后的产物，hexo 存放项目的源代码，不同的是这次是直接依赖于 <a href="https://github.com/features/actions">Github Action</a> 来进行构建和发布，网站使用 <a href="https://www.yarnpkg.cn/">Yarn</a> 进行包管理</p><h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><h3 id="添加构建脚本"><a href="#添加构建脚本" class="headerlink" title="添加构建脚本"></a>添加构建脚本</h3><p>在项目源码分支的根目录，添加 <mark class="hl-label blue">.github</mark> ，<mark class="hl-label blue">workflows</mark>  文件夹，并添加 <mark class="hl-label pink">file-name.yml</mark>  文件（我这里命名为 action.yml），结构如下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">incoderapp.github.io/</span><br><span class="line">    ├── .github/workflows/             # action 相关文件夹</span><br><span class="line">    │   └── action.yml                 # 执行任务配置文件</span><br><span class="line">    ├── scaffolds/</span><br><span class="line">    ├── source/</span><br><span class="line">    ├── themes/</span><br><span class="line">    ├── _config.butterfly.yml</span><br><span class="line">    ├── _config.yml</span><br><span class="line">    ├── .gitignore</span><br><span class="line">    ├── LICENSE</span><br><span class="line">    ├── package.json</span><br><span class="line">    ├── README.md</span><br><span class="line">    └── yarn.lock</span><br></pre></td></tr></table></figure><p>action.yml 文件的配置命令如下所示</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">CI</span></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">branches:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">hexo</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span> <span class="string">branch</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">dependencies</span></span><br><span class="line">        <span class="attr">if:</span> <span class="string">steps.cache.outputs.cache-hit</span> <span class="type">!=</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">yarn</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Hexo</span> <span class="string">clean</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">heowc/action-hexo@main</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">args:</span> <span class="string">clean</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Hexo</span> <span class="string">generate</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">heowc/action-hexo@main</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">args:</span> <span class="string">generate</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Deploy</span> <span class="string">to</span> <span class="string">master</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">peaceiris/actions-gh-pages@v3</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">personal_token:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.CI_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">external_repository:</span> <span class="string">IncoderApp/incoderapp.github.io</span></span><br><span class="line">          <span class="attr">publish_branch:</span> <span class="string">master</span></span><br><span class="line">          <span class="attr">publish_dir:</span> <span class="string">./public</span></span><br></pre></td></tr></table></figure><h3 id="添加相关配置"><a href="#添加相关配置" class="headerlink" title="添加相关配置"></a>添加相关配置</h3><p>我们需要在项目的 Settings 标签中添加一个 Secrets，用于部署访问仓库的 Token，关于生成项目的 Token</p><ul><li><kbd>Github</kbd>-&gt;<kbd>头像（右上角）</kbd>-&gt;<kbd>Settings</kbd>-&gt;<kbd>Developer Settings</kbd>-&gt;<kbd>Personal access tokens</kbd></li><li>勾选 <kbd>repo</kbd></li><li>复制生成的 tocken（生成的token只有一次可见机会，请妥善保存），添加到项目的 Settings 标签中 Secrets 选项，并命名为 <mark class="hl-label pink">CI_TOKEN</mark> </li></ul><h3 id="编译及测试"><a href="#编译及测试" class="headerlink" title="编译及测试"></a>编译及测试</h3><p>当我们有 push 动作到 hexo 分支，Github Action 会自动进行安装我们的构建任务执行，我们需要关注项目 Action 标签页，如果有错误，在 Action 标签页中查看相关的错误并解决，当然为了我们方便直观的查看项目的构建情况，我们可以按照官方给定的特殊写法，通过徽章的形式，方便的查看项目的构建结果，比如我这里就按照官方写法 <img src="https://github.com/IncoderApp/incoderapp.github.io/actions/workflows/action.yml/badge.svg?branch=hexo"></img></p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="https://docs.github.com/cn/actions">Github Action 官方文档</a></li><li><a href="https://lovobin.github.io/2021/03/11/55808">Github-Actions-自动化部署总结</a></li><li><a href="https://docs.github.com/cn/actions/managing-workflow-runs/adding-a-workflow-status-badge">添加工作流程状态徽章</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Build </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Github Action </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
